<div class="flex justify-center items-center mb-6 bg-white p-3 rounded-lg shadow-sm border border-gray-200">
    <a href="<%= prevLink %>" class="p-2 hover:bg-gray-100 rounded-full transition-colors" title="Mês Anterior">
        <i data-lucide="chevron-left" class="w-6 h-6 text-gray-600"></i>
    </a>
    <div class="mx-6 text-center w-48">
        <h2 class="text-lg font-bold text-gray-800 capitalize flex items-center justify-center gap-2">
            <i data-lucide="calendar" class="w-5 h-5 text-amber-500"></i>
            <%= currentDateDisplay %>
        </h2>
    </div>
    <a href="<%= nextLink %>" class="p-2 hover:bg-gray-100 rounded-full transition-colors" title="Próximo Mês">
        <i data-lucide="chevron-right" class="w-6 h-6 text-gray-600"></i>
    </a>
</div>

<div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
    <h2 class="text-2xl font-bold text-gray-800 border-l-4 border-amber-500 pl-3">
        Transações do Mês
    </h2>
    <button onclick="showForm()" class="flex items-center gap-2 bg-black hover:bg-neutral-800 text-white px-5 py-2.5 rounded-md transition-all shadow-md text-sm font-medium uppercase">
        <i data-lucide="plus" class="w-4 h-4"></i>
        Nova Transação
    </button>
</div>

<div id="transactionFormContainer" class="hidden mb-8 bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden animate-fade-in-down">
    <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
        <h3 class="text-lg font-bold text-gray-800" id="formTitle">Nova Transação</h3>
        <button type="button" onclick="hideForm()" class="text-gray-400 hover:text-red-500"><i data-lucide="x" class="w-5 h-5"></i></button>
    </div>
    <form id="transactionForm" class="p-6">
        <input type="hidden" id="transactionId">
        <div class="mb-4">
            <label class="block text-xs font-bold text-gray-600 uppercase mb-2">Tipo de Movimentação</label>
            <div class="flex gap-4">
                <label class="flex items-center gap-2 cursor-pointer p-2 border border-gray-200 rounded hover:bg-gray-50 w-full transition-colors">
                    <input type="radio" name="transactionType" id="typeExpense" value="EXPENSE" checked class="text-red-600 focus:ring-red-500" onchange="filterCategories()">
                    <span class="text-sm font-medium text-red-600">Despesa (Saída)</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer p-2 border border-gray-200 rounded hover:bg-gray-50 w-full transition-colors">
                    <input type="radio" name="transactionType" id="typeIncome" value="INCOME" class="text-green-600 focus:ring-green-500" onchange="filterCategories()">
                    <span class="text-sm font-medium text-green-600">Receita (Entrada)</span>
                </label>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-4">
            <div>
                <label class="block text-xs font-bold text-gray-600 uppercase mb-2">Recorrência</label>
                <select id="recurrence" name="recurrence" required class="w-full border-gray-300 rounded-md py-2 px-3 bg-white border" onchange="toggleInstallments()">
                    <option value="VARIABLE">Variável</option>
                    <option value="FIXED">Fixa</option>
                </select>
            </div>
            <div id="installmentsContainer">
                <label class="block text-xs font-bold text-gray-600 uppercase mb-2">Parcelas</label>
                <div class="relative">
                    <input type="number" id="installments" name="installments" value="1" min="1" max="60" class="w-full border-gray-300 rounded-md py-2 px-3 border">
                    <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                        <span class="text-gray-400 text-xs">x</span>
                    </div>
                </div>
            </div>
            <div id="fixedNoticeContainer" class="hidden items-end pb-2">
                <p class="text-xs text-blue-600 font-medium flex items-center gap-1 bg-blue-50 px-3 py-2 rounded-md w-full border border-blue-100">
                    <i data-lucide="infinity" class="w-4 h-4"></i> Todos os meses
                </p>
            </div>
            <div>
                <label for="date" class="block text-xs font-bold text-gray-600 uppercase mb-2">Data</label>
                <input type="date" id="date" name="date" required class="w-full border-gray-300 rounded-md py-2 px-3 border">
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div>
                <label for="accountId" class="block text-xs font-bold text-gray-600 uppercase mb-2">Usuário (Conta)</label>
                <select id="accountId" name="accountId" required class="w-full border-gray-300 rounded-md py-2 px-3 bg-white border">
                    <option value="">Selecione...</option>
                    <% accounts.forEach(acc => { %>
                        <option value="<%= acc.id %>"><%= acc.name %></option>
                    <% }); %>
                </select>
            </div>
            <div>
                <label for="categoryId" class="block text-xs font-bold text-gray-600 uppercase mb-2">Categoria</label>
                <select id="categoryId" name="categoryId" required class="w-full border-gray-300 rounded-md py-2 px-3 bg-white border">
                    <option value="">Selecione...</option>
                    <% categories.forEach(cat => { %>
                        <option value="<%= cat.id %>" data-type="<%= cat.type %>"><%= cat.name %></option>
                    <% }); %>
                </select>
            </div>
            <div>
                <label for="value" class="block text-xs font-bold text-gray-600 uppercase mb-2">Valor (R$)</label>
                <input type="number" step="0.01" id="value" name="value" required placeholder="0.00" class="w-full border-gray-300 rounded-md py-2 px-3 border">
            </div>
        </div>
        <div class="mb-6">
            <label for="description" class="block text-xs font-bold text-gray-600 uppercase mb-2">Descrição (Opcional)</label>
            <input type="text" id="description" name="description" class="w-full border-gray-300 rounded-md py-2 px-3 border" placeholder="Ex: Compra no supermercado, salário, etc.">
        </div>
        <div class="flex justify-end gap-3">
            <button type="button" onclick="hideForm()" class="px-4 py-2 border rounded-md text-gray-600 hover:bg-gray-50 text-sm font-medium">Cancelar</button>
            <button type="submit" id="saveBtn" class="px-4 py-2 bg-amber-500 text-white rounded-md hover:bg-amber-600 flex items-center gap-2 text-sm font-medium transition-colors">
                <i data-lucide="save" class="w-4 h-4"></i> Salvar
            </button>
        </div>
    </form>
</div>

<div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200" id="transactionsTable">
            <thead class="bg-gray-50">
                <tr>
                    <th onclick="sortTable(0)" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase cursor-pointer hover:bg-gray-100 transition-colors select-none group">
                        <div class="flex items-center gap-1">
                            Data
                            <i data-lucide="arrow-up-down" class="w-3 h-3 text-gray-400 group-hover:text-amber-500"></i>
                        </div>
                    </th>
                    
                    <th onclick="sortTable(1)" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase cursor-pointer hover:bg-gray-100 transition-colors select-none group">
                        <div class="flex items-center gap-1">
                            Detalhes
                            <i data-lucide="arrow-up-down" class="w-3 h-3 text-gray-400 group-hover:text-amber-500"></i>
                        </div>
                    </th>

                    <th onclick="sortTable(2)" class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase cursor-pointer hover:bg-gray-100 transition-colors select-none group">
                        <div class="flex items-center gap-1">
                            Recorrência
                            <i data-lucide="arrow-up-down" class="w-3 h-3 text-gray-400 group-hover:text-amber-500"></i>
                        </div>
                    </th>

                    <th onclick="sortTable(3)" class="px-6 py-3 text-right text-xs font-bold text-gray-600 uppercase cursor-pointer hover:bg-gray-100 transition-colors select-none group">
                        <div class="flex items-center justify-end gap-1">
                            Valor
                            <i data-lucide="arrow-up-down" class="w-3 h-3 text-gray-400 group-hover:text-amber-500"></i>
                        </div>
                    </th>

                    <th class="px-6 py-3 text-right text-xs font-bold text-gray-600 uppercase">Ações</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                <% if(transactions && transactions.length > 0) { %>
                    <% transactions.forEach(t => { %>
                    <tr class="hover:bg-gray-50 group transition-colors">
                        
                        <td class="px-6 py-4 text-sm text-gray-600 font-mono" data-val="<%= t.date %>">
                            <%= t.date.split('-').reverse().join('/') %>
                        </td>
                        
                        <td class="px-6 py-4" data-val="<%= t.description %>">
                            <p class="text-sm font-medium text-gray-800"><%= t.description || 'Sem descrição' %></p>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-xs text-gray-500 bg-gray-100 px-1.5 py-0.5 rounded">
                                    <%= t.account ? t.account.name : '?' %>
                                </span>
                                <span class="text-xs text-gray-400">•</span>
                                <span class="text-xs text-gray-500">
                                    <%= t.category ? t.category.name : '?' %>
                                </span>
                                <% if(t.totalInstallments > 1) { %>
                                    <span class="ml-1 text-[10px] font-bold bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded">
                                        <%= t.currentInstallment %>/<%= t.totalInstallments %>
                                    </span>
                                <% } %>
                            </div>
                        </td>

                        <td class="px-6 py-4" data-val="<%= t.recurrence %>">
                            <span class="text-[10px] uppercase px-2 py-1 rounded-full font-bold border <%= t.recurrence === 'FIXED' ? 'bg-blue-50 text-blue-700 border-blue-200' : 'bg-orange-50 text-orange-700 border-orange-200' %>">
                                <%= t.recurrence === 'FIXED' ? 'Fixa' : 'Variável' %>
                            </span>
                        </td>

                        <td class="px-6 py-4 text-right whitespace-nowrap" data-val="<%= t.value %>">
                            <span class="font-bold font-mono <%= t.transactionType === 'INCOME' ? 'text-green-600' : 'text-red-600' %>">
                                <%= t.transactionType === 'INCOME' ? '+' : '-' %> R$ <%= Number(t.value).toFixed(2) %>
                            </span>
                        </td>
                        
                        <td class="px-6 py-4 text-right">
                            <div class="flex justify-end gap-2">
                                <button onclick="editTransaction(<%= JSON.stringify(t) %>)" class="text-indigo-600 hover:text-indigo-900 p-1.5 rounded hover:bg-indigo-50 transition-colors" title="Editar">
                                    <i data-lucide="pencil" class="w-4 h-4"></i>
                                </button>
                                <button onclick="deleteTransaction(<%= t.id %>)" class="text-red-600 hover:text-red-900 p-1.5 rounded hover:bg-red-50 transition-colors" title="Excluir">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    <% }); %>
                <% } else { %>
                    <tr><td colspan="5" class="p-10 text-center text-gray-500 flex flex-col items-center justify-center">
                        <i data-lucide="inbox" class="w-8 h-8 text-gray-300 mb-2"></i>
                        <span>Nenhuma transação encontrada neste mês.</span>
                    </td></tr>
                <% } %>
            </tbody>
        </table>
    </div>
</div>

<script>
    if (typeof lucide !== 'undefined') lucide.createIcons();
    
    const currentViewDate = "<%= queryDate %>"; 
    const formContainer = document.getElementById('transactionFormContainer');
    const form = document.getElementById('transactionForm');
    const formTitle = document.getElementById('formTitle');
    const installmentsDiv = document.getElementById('installmentsContainer');
    const fixedNoticeDiv = document.getElementById('fixedNoticeContainer');

    let sortDirection = 1; 
    let lastColumn = -1;

    function sortTable(columnIndex) {
        const table = document.getElementById("transactionsTable");
        const tbody = table.querySelector("tbody");
        const rows = Array.from(tbody.querySelectorAll("tr"));

        if (lastColumn === columnIndex) {
            sortDirection *= -1;
        } else {
            sortDirection = 1; 
            lastColumn = columnIndex;
        }

        rows.sort((a, b) => {
           
            const cellA = a.querySelectorAll("td")[columnIndex];
            const cellB = b.querySelectorAll("td")[columnIndex];
            
            if(!cellA || !cellB) return 0;

            const valA = cellA.getAttribute("data-val").toLowerCase();
            const valB = cellB.getAttribute("data-val").toLowerCase();

            const numA = parseFloat(valA);
            const numB = parseFloat(valB);

            if (!isNaN(numA) && !isNaN(numB)) {
                return (numA - numB) * sortDirection;
            }

            return valA.localeCompare(valB) * sortDirection;
        });

        tbody.innerHTML = "";
        rows.forEach(row => tbody.appendChild(row));
        
    }


    function showForm() {
        formContainer.classList.remove('hidden');
        form.reset(); 
        
        document.getElementById('transactionId').value = ''; 
        
        const today = new Date();
        const currentMonthSystem = today.toISOString().slice(0, 7); 

        if (currentViewDate === currentMonthSystem) {
            document.getElementById('date').valueAsDate = today;
        } else {
            document.getElementById('date').value = currentViewDate + "-01";
        }

        formTitle.textContent = 'Nova Transação';
        document.getElementById('typeExpense').checked = true;
        document.getElementById('recurrence').value = 'VARIABLE';
        document.getElementById('installments').value = 1;
        
        filterCategories(); 
        toggleInstallments();
        
        formContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function hideForm() { 
        formContainer.classList.add('hidden'); 
        form.reset(); 
    }

    function toggleInstallments() {
        const rec = document.getElementById('recurrence').value;
        const idField = document.getElementById('transactionId').value;

        if (idField) {
            installmentsDiv.classList.add('hidden');
            if (fixedNoticeDiv) fixedNoticeDiv.classList.add('hidden');
            return;
        }

        if (rec === 'FIXED') {
            installmentsDiv.classList.add('hidden');
            if (fixedNoticeDiv) fixedNoticeDiv.classList.remove('hidden');
            document.getElementById('installments').value = 1; 
            document.getElementById('installments').required = false;
        } else {
            installmentsDiv.classList.remove('hidden');
            if (fixedNoticeDiv) fixedNoticeDiv.classList.add('hidden');
            document.getElementById('installments').required = true;
        }
        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function filterCategories() {
        const selectedType = document.querySelector('input[name="transactionType"]:checked').value;
        const select = document.getElementById('categoryId');
        const options = select.querySelectorAll('option');
        
        const currentValue = select.value;
        select.value = ""; 

        options.forEach(opt => {
            if (opt.value === "") return;
            const categoryType = opt.getAttribute('data-type');
            if (categoryType === selectedType) {
                opt.style.display = 'block'; 
                opt.disabled = false;
            } else {
                opt.style.display = 'none';
                opt.disabled = true;
            }
        });
        
        for (let opt of options) {
            if (opt.value === currentValue && !opt.disabled) {
                select.value = currentValue;
                break;
            }
        }
    }

    function editTransaction(t) {
        showForm(); 
        formTitle.textContent = 'Editar Transação';
        document.getElementById('transactionId').value = t.id;
        document.getElementById('value').value = t.value;
        document.getElementById('description').value = t.description;
        document.getElementById('recurrence').value = t.recurrence;
        document.getElementById('date').value = t.date; 
        
        if (t.transactionType === 'INCOME') {
            document.getElementById('typeIncome').checked = true;
        } else {
            document.getElementById('typeExpense').checked = true;
        }

        filterCategories();
        document.getElementById('accountId').value = t.accountId;
        document.getElementById('categoryId').value = t.categoryId;

        installmentsDiv.classList.add('hidden');
        if (fixedNoticeDiv) fixedNoticeDiv.classList.add('hidden');
        formContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const saveBtn = document.getElementById('saveBtn');
        const originalText = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Salvando...';
        lucide.createIcons();

        const id = document.getElementById('transactionId').value;
        const url = id ? `/transactions/${id}` : '/transactions';
        const method = id ? 'PUT' : 'POST';
        
        const data = {
            transactionType: document.querySelector('input[name="transactionType"]:checked').value,
            date: document.getElementById('date').value,
            accountId: document.getElementById('accountId').value,
            categoryId: document.getElementById('categoryId').value,
            value: document.getElementById('value').value,
            description: document.getElementById('description').value,
            recurrence: document.getElementById('recurrence').value,
            installments: document.getElementById('installments').value
        };

        try {
            const res = await fetch(url, { 
                method: method, 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify(data) 
            });

            if(res.ok) {
                window.location.href = `/transactions/view?date=${currentViewDate}`;
            } else {
                const err = await res.json();
                alert("Erro: " + (err.message || "Erro desconhecido"));
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            }
        } catch(err) { 
            alert("Erro de rede."); 
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
        }
    });

    async function deleteTransaction(id) {
        if(confirm("Tem certeza que deseja excluir esta transação?")) {
            try {
                const res = await fetch(`/transactions/${id}`, { method: 'DELETE' });
                if(res.ok) window.location.reload();
                else alert("Erro ao excluir.");
            } catch (e) { alert("Erro de rede."); }
        }
    }
</script>